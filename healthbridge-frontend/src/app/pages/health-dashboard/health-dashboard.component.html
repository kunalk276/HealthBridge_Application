<div class="min-h-[calc(100vh-160px)] bg-gradient-to-br from-blue-50 to-blue-100 py-10">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">

    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-block bg-gradient-to-r from-blue-400 to-blue-600 text-white px-5 py-1 rounded-full shadow-md mb-3">
        <h2 class="text-2xl md:text-3xl font-semibold tracking-wide">
          <i class="fa-brands fa-accusoft"></i> {{ 'dashboard.header.welcome' | translate }} {{ userName }}
        </h2>
      </div>
      <p class="text-gray-600 mt-2 text-sm md:text-base">
        <i class="fa-solid fa-location-dot"></i>
        <span class="font-medium text-gray-800">{{ 'dashboard.header.location' | translate }}:</span>
        {{ userLocation }}
      </p>
    </div>

    <!-- Analytics Toggle Button -->
    <div class="mb-6 text-center">
      <button
        (click)="toggleAnalytics()"
        class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all flex items-center gap-2 mx-auto">
        <span *ngIf="!showAnalytics"><i class="fa-solid fa-chart-line"></i> {{ 'dashboard.analytics.view' | translate }}</span>
        <span *ngIf="showAnalytics"><i class="fa-solid fa-chart-line"></i> {{ 'dashboard.analytics.hide' | translate }}</span>
      </button>
    </div>

    <!-- Analytics Section -->
    <div *ngIf="showAnalytics" class="mb-8 bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl shadow-md border-2 border-purple-200">

      <!-- Loading Analytics -->
      <div *ngIf="isLoadingAnalytics" class="text-center py-8">
        <div class="inline-flex items-center gap-3 text-purple-600">
          <div class="animate-spin h-8 w-8 border-4 border-purple-300 border-t-purple-600 rounded-full"></div>
          <span class="font-medium text-lg">{{ 'dashboard.analytics.loading' | translate }}</span>
        </div>
      </div>

      <!-- Analytics Content -->
      <div *ngIf="!isLoadingAnalytics && userAnalytics">
        <h3 class="text-2xl font-bold text-purple-700 mb-6 flex items-center gap-2">
          {{ 'dashboard.analytics.title' | translate }}
          <span class="text-sm font-normal text-gray-600">({{ 'dashboard.analytics.total_records' | translate }}: {{ userAnalytics.totalRecords }})</span>
        </h3>

        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <!-- Health Status -->
          <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-purple-500">
            <h4 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <i class="fa-solid fa-hospital"></i> {{ 'dashboard.analytics.health_status' | translate }}
            </h4>
            <p [ngClass]="getHealthStatusColor()" class="text-lg font-bold">
              {{ userAnalytics.healthStatus }}
            </p>
          </div>

          <!-- Total Records -->
          <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-blue-500">
            <h4 class="font-semibold text-gray-700 mb-3"><i class="fa-solid fa-file-prescription"></i> {{ 'dashboard.analytics.total_symptoms' | translate }}</h4>
            <p class="text-3xl font-bold text-blue-600">{{ userAnalytics.totalRecords }}</p>
          </div>

          <!-- Severity Overview -->
          <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-orange-500">
            <h4 class="font-semibold text-gray-700 mb-3"><i class="fa-solid fa-biohazard"></i> {{ 'dashboard.analytics.severity_overview' | translate }}</h4>
            <div class="space-y-2">
              <div *ngFor="let severity of getSeverityKeys()" class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600">{{ severity }}:</span>
                <span [ngClass]="getSeverityColor(severity)" class="px-2 py-1 rounded text-white text-xs font-bold">
                  {{ userAnalytics.severityDistribution[severity] }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Common Symptoms -->
        <div *ngIf="getSymptomKeys().length > 0" class="mb-6 bg-white p-5 rounded-lg shadow-md">
          <h4 class="font-semibold text-gray-700 mb-4 text-lg"><i class="fa-solid fa-searchengin"></i> {{ 'dashboard.analytics.common_symptoms' | translate }}</h4>

          <div class="space-y-3 max-h-96 overflow-y-auto">
            <div *ngFor="let symptom of getSymptomKeys()" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <p class="text-gray-800 font-medium text-sm">{{ symptom }}</p>
                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold">
                  {{ userAnalytics.commonSymptoms[symptom] }} {{ 'dashboard.analytics.times' | translate }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Severity Progress Bars -->
        <div class="bg-white p-5 rounded-lg shadow-md">
          <h4 class="font-semibold text-gray-700 mb-4 text-lg"><i class="fa-solid fa-chart-line"></i> {{ 'dashboard.analytics.severity_breakdown' | translate }}</h4>
          <div class="space-y-3">
            <div *ngFor="let severity of getSeverityKeys()" class="flex items-center gap-4">
              <span class="w-24 font-semibold text-gray-700">{{ severity }}</span>
              <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                <div
                  [ngClass]="getSeverityColor(severity)"
                  [style.width.%]="(userAnalytics.severityDistribution[severity] / userAnalytics.totalRecords) * 100"
                  class="h-6 rounded-full transition-all duration-500 flex items-center justify-end pr-2">
                  <span class="text-white text-xs font-bold">
                    {{ userAnalytics.severityDistribution[severity] }}
                  </span>
                </div>
              </div>
              <span class="w-16 text-sm text-gray-600 text-right">
                {{ ((userAnalytics.severityDistribution[severity] / userAnalytics.totalRecords) * 100).toFixed(1) }}%
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- No Data -->
      <div *ngIf="!isLoadingAnalytics && !userAnalytics" class="text-center py-8">
        <p class="text-gray-500 text-lg">
          <i class="fa-solid fa-file-prescription"></i> {{ 'dashboard.analytics.no_records' | translate }}
        </p>
      </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid md:grid-cols-2 gap-10">

      <!-- AI Assistant -->
      <div class="bg-blue-50 p-6 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-gray-700 mb-4"><i class="fa-solid fa-comment-nodes"></i> {{ 'dashboard.ai.title' | translate }}</h3>

        <textarea
          [(ngModel)]="message"
          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400 text-gray-700"
          rows="4"
          [placeholder]="'dashboard.ai.placeholder' | translate"></textarea>

        <div class="flex items-center justify-between mt-4">
          <button
            (click)="sendMessage()"
            [disabled]="isLoadingAI"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition">
            <span *ngIf="!isLoadingAI">{{ 'dashboard.ai.send' | translate }}</span>
            <span *ngIf="isLoadingAI">{{ 'dashboard.ai.analyzing' | translate }}</span>
          </button>

          <button
            (click)="toggleVoiceInput()"
            [ngClass]="isListening ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'"
            class="px-4 py-2 rounded-lg transition flex items-center gap-2">
            <span *ngIf="!isListening"><i class="fa-solid fa-microphone"></i> {{ 'dashboard.ai.speak' | translate }}</span>
            <span *ngIf="isListening"><i class="fa-solid fa-octagon"></i> {{ 'dashboard.ai.stop' | translate }}</span>
            <div *ngIf="isListening" class="mic-pulse w-3 h-3 rounded-full bg-red-400"></div>
          </button>
        </div>

        <div *ngIf="isListening" class="mt-4 h-12 bg-gray-100 rounded-lg flex items-center px-3">
          <div class="flex gap-1 w-full">
            <div *ngFor="let v of waveformData" [style.height.px]="v / 3" class="w-1 bg-blue-600 rounded"></div>
          </div>
        </div>

        <div *ngIf="isLoadingAI" class="mt-4">
          <div class="flex items-center gap-3 text-blue-600">
            <div class="animate-spin h-6 w-6 border-4 border-blue-300 border-t-blue-600 rounded-full"></div>
            <span class="font-medium">{{ 'dashboard.ai.analyzing' | translate }}</span>
          </div>
        </div>

        <div *ngIf="aiResponse" class="mt-6 bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
          <h4 class="text-gray-800 font-medium mb-2"><i class="fa-solid fa-hexagon-nodes"></i> {{ 'dashboard.ai.response' | translate }}</h4>
          <p class="text-gray-600 whitespace-pre-line">{{ aiResponse }}</p>
        </div>

        <div *ngIf="severityLevel" class="mt-4">
          <span
            class="px-3 py-1 rounded-full text-white text-sm font-semibold"
            [ngClass]="{
              'bg-green-600': severityScore <= 3,
              'bg-orange-500': severityScore > 3 && severityScore < 7,
              'bg-red-600': severityScore >= 7
            }">
            {{ 'dashboard.ai.severity' | translate }}: {{ severityLevel }} ({{ severityScore }})
          </span>
        </div>

        <div *ngIf="severityScore >= 7" class="mt-4">
          <div *ngIf="smsSending" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
            <p class="text-yellow-700 font-medium">{{ 'dashboard.ai.sms.sending' | translate }}</p>
          </div>

          <div *ngIf="smsSent" class="bg-green-50 border border-green-200 rounded-lg p-3 text-center mt-2">
            <p class="text-green-700 font-medium"><i class="fa-solid fa-check"></i> {{ 'dashboard.ai.sms.sent' | translate }}</p>
          </div>

          <div *ngIf="smsError" class="bg-red-50 border border-red-200 rounded-lg p-3 text-center mt-2">
            <p class="text-red-700 font-medium"><i class="fa-solid fa-triangle-exclamation"></i> {{ smsError }}</p>
          </div>
        </div>
      </div>

      <!-- Nearby Hospitals -->
      <div class="bg-blue-50 p-6 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-gray-700 mb-4"><i class="fa-solid fa-location-dot"></i> {{ 'dashboard.hospitals.title' | translate }}</h3>

        <ul class="space-y-3 max-h-[500px] overflow-y-auto">
          <li *ngFor="let hospital of hospitals" class="bg-white p-4 rounded-lg border shadow-sm hover:shadow-md transition">
            <h4 class="font-medium text-gray-800">{{ hospital.name }}</h4>
            <p class="text-sm text-gray-600"><i class="fa-solid fa-hospital"></i> {{ hospital.address }}</p>

            <p class="text-sm text-gray-600 mt-1">
              <i class="fa-solid fa-phone"></i>
              <ng-container *ngIf="hospital.contact && hospital.contact !== 'Not available'; else noPhone">
                <a [href]="'tel:' + hospital.contact" class="text-blue-600 hover:underline">
                  {{ hospital.contact }}
                </a>
              </ng-container>
              <ng-template #noPhone>{{ 'dashboard.hospitals.no_contact' | translate }}</ng-template>
            </p>

            <button
              (click)="openMap(hospital)"
              class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded-lg">
              <i class="fa-solid fa-location-dot"></i> {{ 'dashboard.hospitals.view_map' | translate }}
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.5); opacity: 0.5; }
}
.mic-pulse { animation: pulse 1.5s ease-in-out infinite; }
</style>
